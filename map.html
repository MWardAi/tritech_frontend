<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartTourist Map</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />
  
  <style>
    :root{
      --cream-1: #fffdf8;
      --cream-2: #fff6ea;
      --accent: #6aa6ff;
      --muted: #7b7b7b;
      --radius: 14px;
      --shadow: 0 8px 30px rgba(20,20,30,0.08);
    }

    html,body{
      height:100%;
      margin:0;
      background: linear-gradient(180deg, var(--cream-1) 0%, #eaf6ff 100%);
      color:#1b1b1b;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    nav {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 20px;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }

    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:8px 12px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:600;
      color:white;
      background: linear-gradient(90deg, var(--accent), #4b8bff);
      box-shadow: 0 6px 20px rgba(75,139,255,0.08);
    }

    .btn.secondary {
      background: transparent;
      color:var(--accent);
      border:1px solid rgba(106,166,255,0.12);
      box-shadow:none;
    }

    .small {
      font-size:13px;
      color:var(--muted);
    }

    .nav-profile {
      position: relative;
    }

    .nav-profile-btn {
      width:36px;
      height:36px;
      border-radius:8px;
      background:linear-gradient(135deg,#6aa6ff,#4b8bff);
      border:none;
      color:#fff;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .nav-profile-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: white;
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 12px;
      min-width: 180px;
      z-index: 1000;
      border: 1px solid rgba(0,0,0,0.03);
    }

    main {
      padding:24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    #map-container {
      width:100%;
      height:70vh;
      border-radius:var(--radius);
      border:1px solid rgba(0,0,0,0.08);
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,0.6);
      margin-top: 20px;
      overflow: hidden;
    }

    .leaflet-control {
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .leaflet-bar {
      border: 1px solid rgba(0,0,0,0.06);
    }

    .leaflet-bar a {
      background-color: white;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      color: #333;
      transition: all 0.2s ease;
    }

    .leaflet-bar a:hover {
      background-color: var(--cream-2);
      color: var(--accent);
    }

    .leaflet-control-zoom-in, .leaflet-control-zoom-out {
      font-size: 16px;
      line-height: 24px;
    }

    .map-title {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(6px);
      padding: 10px 16px;
      border-radius: var(--radius);
      border: 1px solid rgba(0,0,0,0.06);
      font-weight: 600;
      box-shadow: var(--shadow);
    }

    .map-legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(6px);
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(0,0,0,0.06);
      font-size: 12px;
      box-shadow: var(--shadow);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    @keyframes pulse {
      0% { transform: scale(0.95); opacity: 0.7; }
      50% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(0.95); opacity: 0.7; }
    }
    
    .user-location-marker {
      animation: pulse 2s infinite;
    }

    @media (max-width: 768px) {
      #map-container {
        height: 60vh;
      }
      
      .map-title {
        font-size: 14px;
        padding: 8px 12px;
        top: 10px;
        left: 10px;
      }
      
      .map-legend {
        bottom: 10px;
        right: 10px;
        padding: 8px;
        font-size: 11px;
      }
    }
  </style>
  
  <script>
    window.BASE_URL = window.BASE_URL || 'https://tritech-backend-1w10.onrender.com';
  </script>
</head>
<body>
  <nav>
    <div style="font-weight:800; font-size: 18px;">Smart Tourist</div>
    
    <div id="nav-profile" class="nav-profile" style="display:none;">
      <button id="nav-profile-btn" class="nav-profile-btn" aria-haspopup="true" aria-expanded="false" title="Open profile menu">
        <span id="nav-profile-initial">U</span>
      </button>

      <div id="nav-profile-menu" class="nav-profile-menu" role="menu" aria-hidden="true" style="display:none;">
        <div id="nav-profile-username" class="small" style="margin-bottom:8px;font-weight:700;">Username</div>
        <div style="display:flex;gap:8px;">
          <button id="nav-logout" class="btn secondary" type="button" style="font-size: 12px;">Log out</button>
          <button id="nav-open-profile" class="btn" type="button" style="font-size: 12px;">Profile</button>
        </div>
      </div>
    </div>
  </nav>

  <main>
    <h1 style="margin: 0;">Interactive Map</h1>
    <p class="small">Explore tourist attractions in Syria. Click on markers for details.</p>
    
    <div id="map-container">
      <div class="map-title">üó∫Ô∏è Damascus, Syria</div>
      <div class="map-legend">
        <div class="legend-item">
          <span class="legend-color" style="background-color: #6aa6ff;"></span>
          <span>Tourist Attraction</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: #ff6a6a;"></span>
          <span>Historical Site</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: #4bff8b;"></span>
          <span>Cultural Site</span>
        </div>
        <div class="legend-item" id="user-location-legend" style="display: none;">
          <div style="display: flex; align-items: center; gap: 6px;">
            <div style="width: 16px; height: 16px; border-radius: 50%; background: linear-gradient(135deg, #6aa6ff, #4b8bff); border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
              <div style="font-size: 8px; color: white; font-weight: bold;">U</div>
            </div>
            <span>Your Location</span>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.8); border-radius: var(--radius); border: 1px solid rgba(0,0,0,0.06);">
      <h3 style="margin-top: 0;">GPS Location Tracking</h3>
      <p class="small" style="margin-bottom: 15px;">
        Share your location to get personalized recommendations and track your journey.
        <br><strong>Privacy:</strong> Your location data is stored securely and used only to enhance your experience.
      </p>
      
      <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
        <button id="gps-start-btn" class="btn" style="font-size: 14px;">
          <span style="margin-right: 8px;">üìç</span> Start Tracking
        </button>
        <button id="gps-stop-btn" class="btn secondary" style="font-size: 14px;" disabled>
          <span style="margin-right: 8px;">‚è∏Ô∏è</span> Stop Tracking
        </button>
        <button id="gps-locate-btn" class="btn secondary" style="font-size: 14px;">
          <span style="margin-right: 8px;">üß≠</span> Show My Location
        </button>
        <button id="gps-focus-btn" class="btn secondary" style="font-size: 14px;" disabled>
          <span style="margin-right: 8px;">üéØ</span> Focus on Me
        </button>
        <button id="gps-share-btn" class="btn secondary" style="font-size: 14px;">
          <span style="margin-right: 8px;">üåç</span> Share My Location
        </button>
      </div>
      
      <div id="gps-status" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--cream-2); border-radius: 8px; font-size: 13px;">
        <div id="gps-status-indicator" style="width: 12px; height: 12px; border-radius: 50%; background-color: #ccc;"></div>
        <span id="gps-status-text">GPS not active</span>
        <span id="gps-location-info" style="margin-left: auto; font-family: monospace; color: var(--muted);"></span>
      </div>
      
      <div class="small" style="margin-top: 10px; color: var(--muted);">
        <label>
          <input type="checkbox" id="gps-auto-start" checked>
          Auto-start tracking when I log in
        </label>
      </div>
    </div>
    <!-- Recommendations Section -->
    <div id="recommendations-section" style="margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.8); border-radius: var(--radius); border: 1px solid rgba(0,0,0,0.06);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">Personalized Recommendations</h3>
        <div style="display: flex; gap: 10px;">
          <button id="refresh-recommendations" class="btn secondary" style="font-size: 14px;">
            <span style="margin-right: 8px;">üîÑ</span> Refresh
          </button>
          <button id="show-all-recommendations" class="btn" style="font-size: 14px;">
            <span style="margin-right: 8px;">üåü</span> Show on Map
          </button>
        </div>
      </div>
      
      <div id="recommendations-loading" style="display: none; text-align: center; padding: 20px;">
        <div class="small">Loading recommendations...</div>
      </div>
      
      <div id="recommendations-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 15px;">
        <!-- Recommendations will be loaded here -->
      </div>
      
      <div id="no-recommendations" style="display: none; text-align: center; padding: 20px; background: var(--cream-2); border-radius: 8px;">
        <p class="small">No recommendations available. Please enable GPS tracking for personalized recommendations.</p>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
  
  <script src="api.js"></script>
  <script src="gps-check.js"></script>
  
  <script>
    // Main map application
    (function() {
      // Global state
      const TOKEN_KEY = 'st_token';
      const token = localStorage.getItem(TOKEN_KEY);
      let userProfile = null;
      let map = null;
      let userMarker = null;
      let attractions = [];
      let isSharing = false; // default
      // Redirect if not authenticated
      if (!token) {
        window.location.href = 'auth.html';
        return;
      }
      
      // Helper functions
      function getFlagEmoji(countryName) {
        const flagMap = {
          'Syria': 'üá∏üáæ',
          'Lebanon': 'üá±üáß', 
          'Jordan': 'üáØüá¥',
          'Iraq': 'üáÆüá∂',
          'Egypt': 'üá™üá¨',
          'Turkey': 'üáπüá∑',
          'Other': 'üè≥Ô∏è'
        };
        return flagMap[countryName] || 'üìç';
      }
      
      function getUserInitial(name) {
        if (!name) return '?';
        return name.charAt(0).toUpperCase();
      }
      
      // Update user marker on map
      function updateUserMarker(coords) {
        if (!map) return;
        
        // Remove existing marker
        if (userMarker) {
          map.removeLayer(userMarker);
        }
        
        // Get user data
        const userName = userProfile ? userProfile.username : 'You';
        const userCountry = userProfile ? userProfile.country : 'Unknown';
        const flagEmoji = getFlagEmoji(userCountry);
        
        // Create custom marker icon
        const userMarkerIcon = L.divIcon({
          className: 'user-location-marker',
          html: `
            <div style="position: relative; display: flex; align-items: center; justify-content: center; width: 50px; height: 50px;">
              <!-- Outer circle with pulse animation -->
              <div style="position: absolute; width: 50px; height: 50px; border-radius: 50%; background: rgba(106, 166, 255, 0.2); animation: pulse 2s infinite;"></div>
              
              <!-- Inner circle with user info -->
              <div style="position: relative; width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #6aa6ff, #4b8bff); display: flex; flex-direction: column; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.2); overflow: hidden; z-index: 10;">
                <!-- Flag emoji -->
                <div style="font-size: 18px; line-height: 1; margin-bottom: 2px;">${flagEmoji}</div>
                
                <!-- Initial -->
                <div style="font-size: 10px; font-weight: bold; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); max-width: 36px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0 2px;">
                  ${getUserInitial(userName)}
                </div>
              </div>
              
              <!-- Tooltip triangle -->
              <div style="position: absolute; top: 42px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 8px solid #6aa6ff; z-index: 5;"></div>
            </div>
          `,
          iconSize: [50, 58],
          iconAnchor: [25, 50],
          popupAnchor: [0, -50]
        });
        
        // Create marker
        userMarker = L.marker([coords.latitude, coords.longitude], {
          icon: userMarkerIcon,
          zIndexOffset: 1000,
          title: `${userName}'s location`
        }).addTo(map);
        
        // Enhanced popup
        const popupContent = `
          <div style="min-width: 180px; padding: 12px; text-align: center;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; justify-content: center;">
              <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #6aa6ff, #4b8bff); display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                <div style="font-size: 16px;">${flagEmoji}</div>
                <div style="font-size: 10px; color: white; font-weight: bold;">${getUserInitial(userName)}</div>
              </div>
              <div style="text-align: left;">
                <div style="font-weight: 800; font-size: 16px; color: #1b1b1b;">${userName}</div>
                <div style="display: flex; align-items: center; gap: 5px; font-size: 13px; color: #7b7b7b;">
                  <span style="font-size: 16px;">${flagEmoji}</span>
                  <span>${userCountry}</span>
                </div>
              </div>
            </div>
            <div style="background: var(--cream-2); border-radius: 8px; padding: 8px; margin: 8px 0; font-size: 12px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                <div>
                  <div style="color: var(--muted); font-size: 11px;">Latitude</div>
                  <div style="font-weight: 600; font-family: monospace;">${coords.latitude.toFixed(6)}</div>
                </div>
                <div>
                  <div style="color: var(--muted); font-size: 11px;">Longitude</div>
                  <div style="font-weight: 600; font-family: monospace;">${coords.longitude.toFixed(6)}</div>
                </div>
              </div>
            </div>
            <div style="font-size: 12px; color: var(--muted);">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>Accuracy:</span>
                <span style="font-weight: 600;">${coords.accuracy ? Math.round(coords.accuracy) + ' m' : 'Unknown'}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span>Updated:</span>
                <span style="font-weight: 600;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
              </div>
            </div>
          </div>
        `;
        
        userMarker.bindPopup(popupContent);
        
        // Center map on user first time
        if (!window.userLocationCentered) {
          map.setView([coords.latitude, coords.longitude], 15);
          window.userLocationCentered = true;
        }
      }
      
      // Update GPS status display
      function updateGPSStatus(isActive, coords = null) {
        const gpsStatusIndicator = document.getElementById('gps-status-indicator');
        const gpsStatusText = document.getElementById('gps-status-text');
        const gpsLocationInfo = document.getElementById('gps-location-info');
        const gpsStartBtn = document.getElementById('gps-start-btn');
        const gpsStopBtn = document.getElementById('gps-stop-btn');
        const gpsFocusBtn = document.getElementById('gps-focus-btn');
        const userLegend = document.getElementById('user-location-legend');
        
        if (!gpsStatusIndicator) return;
        
        if (isActive) {
          gpsStatusIndicator.style.backgroundColor = '#4CAF50';
          gpsStatusText.textContent = 'Tracking active';
          if (gpsStartBtn) gpsStartBtn.disabled = true;
          if (gpsStopBtn) gpsStopBtn.disabled = false;
          if (gpsFocusBtn) gpsFocusBtn.disabled = false;
          if (userLegend) userLegend.style.display = 'flex';
          
          if (coords) {
            const userName = userProfile ? userProfile.username : 'You';
            const userCountry = userProfile ? userProfile.country : '';
            const flagEmoji = getFlagEmoji(userCountry);
            
            if (gpsLocationInfo) {
              gpsLocationInfo.innerHTML = `
                <div style="display: flex; align-items: center; gap: 6px;">
                  <span style="font-size: 16px;">${flagEmoji}</span>
                  <span style="font-weight: 600;">${userName}</span>
                  <span style="color: var(--muted); font-size: 12px;">
                    ${coords.latitude.toFixed(4)}, ${coords.longitude.toFixed(4)}
                  </span>
                </div>
              `;
            }
            
            updateUserMarker(coords);
          }
        } else {
          gpsStatusIndicator.style.backgroundColor = '#ccc';
          gpsStatusText.textContent = 'GPS not active';
          if (gpsStartBtn) gpsStartBtn.disabled = false;
          if (gpsStopBtn) gpsStopBtn.disabled = true;
          if (gpsFocusBtn) gpsFocusBtn.disabled = true;
          if (gpsLocationInfo) gpsLocationInfo.textContent = '';
          if (userLegend) userLegend.style.display = 'none';
          
          if (userMarker && map) {
            map.removeLayer(userMarker);
            userMarker = null;
          }
        }
      }
      
      // Initialize GPS controls
      function initGPSControls() {
        const gpsStartBtn = document.getElementById('gps-start-btn');
        const gpsStopBtn = document.getElementById('gps-stop-btn');
        const gpsLocateBtn = document.getElementById('gps-locate-btn');
        const gpsFocusBtn = document.getElementById('gps-focus-btn');
        const gpsAutoStart = document.getElementById('gps-auto-start');
        
        if (!gpsStartBtn || !window.gpsTracker) return;
        
        // Start GPS tracking
        gpsStartBtn.addEventListener('click', async function() {
          const success = await window.gpsTracker.startTracking();
          updateGPSStatus(success);
          
          if (success) {
            console.log('GPS tracking started successfully');
          } else {
            alert('Failed to start GPS tracking. Please check your location permissions.');
          }
        });

        // Share location button
        const shareBtn = document.getElementById('gps-share-btn');
        if (shareBtn) {
          // Load current sharing status from backend
          async function loadSharingStatus() {
            try {
              const response = await window.api.get('/me/share-location');
              if (response && typeof response.share === 'boolean') {
                isSharing = response.share;
                updateShareButton();
              }
            } catch (err) {
              console.warn('Could not load sharing status:', err);
            }
          }
          
          function updateShareButton() {
            if (isSharing) {
              shareBtn.style.background = 'linear-gradient(90deg, var(--accent), #4b8bff)';
              shareBtn.style.color = 'white';
              shareBtn.innerHTML = '<span style="margin-right: 8px;">üåç</span> Sharing On';
            } else {
              shareBtn.style.background = 'transparent';
              shareBtn.style.color = 'var(--accent)';
              shareBtn.style.border = '1px solid rgba(106,166,255,0.12)';
              shareBtn.innerHTML = '<span style="margin-right: 8px;">üåç</span> Share My Location';
            }
          }
        
          shareBtn.addEventListener('click', async () => {
            if (!window.gpsTracker || !window.gpsTracker.lastPosition) {
              alert('Please start GPS tracking before sharing your location.');
              return;
            }
            const newState = !isSharing;
            try {
              const response = await window.api.patch('/me/share-location', { share: newState });
              if (response && response.share !== undefined) {
                isSharing = response.share;
                updateShareButton();
                showMessage(`Location sharing ${isSharing ? 'enabled' : 'disabled'}`, 'success', 2000);
              }
            } catch (err) {
              console.error('Failed to update sharing preference:', err);
              alert('Could not update sharing preference. Please try again.');
            }
          });
        
          loadSharingStatus();
        }
        
        // Stop GPS tracking
        gpsStopBtn.addEventListener('click', function() {
          window.gpsTracker.stopTracking();
          updateGPSStatus(false);
          console.log('GPS tracking stopped');
        });
        
        // Locate button - center map on current location
        if (gpsLocateBtn) {
          gpsLocateBtn.addEventListener('click', async function() {
            if (!window.gpsTracker) return;
            
            try {
              const position = await window.gpsTracker.getCurrentPosition();
              const coords = position.coords;
              
              // Center map on user
              if (map) {
                map.setView([coords.latitude, coords.longitude], 15);
              }
              
              // Show temporary marker
              if (map) {
                const userName = userProfile ? userProfile.username : 'You';
                const userCountry = userProfile ? userProfile.country : '';
                const flagEmoji = getFlagEmoji(userCountry);
                
                const tempMarker = L.marker([coords.latitude, coords.longitude], {
                  icon: L.divIcon({
                    className: 'temp-location-marker',
                    html: `
                      <div style="position: relative; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px;">
                        <div style="position: absolute; width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 106, 106, 0.3);"></div>
                        <div style="position: relative; width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, #ff6a6a, #ff4b4b); display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                          <div style="font-size: 14px;">${flagEmoji}</div>
                        </div>
                      </div>
                    `,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                  })
                })
                .addTo(map)
                .bindPopup(`<div style="text-align: center; min-width: 150px;"><div style="font-weight: 800; margin-bottom: 5px;">${userName}'s Location</div><div style="display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 8px;"><span style="font-size: 18px;">${flagEmoji}</span><span>${userCountry}</span></div></div>`)
                .openPopup();
                
                setTimeout(() => {
                  if (map && tempMarker) {
                    map.removeLayer(tempMarker);
                  }
                }, 5000);
              }
              
              // Save this location
              window.gpsTracker.savePositionToBackend(position);
              
            } catch (error) {
              console.error('Failed to get location:', error);
              alert('Could not get your location. Please check GPS permissions.');
            }
          });
        }
        
        // Focus button - center on user marker
        if (gpsFocusBtn) {
          gpsFocusBtn.addEventListener('click', function() {
            if (userMarker && map) {
              const latLng = userMarker.getLatLng();
              map.flyTo(latLng, 16, { duration: 1.5 });
              setTimeout(() => userMarker.openPopup(), 1500);
            } else if (window.gpsTracker && window.gpsTracker.lastPosition) {
              const coords = window.gpsTracker.lastPosition.coords;
              map.flyTo([coords.latitude, coords.longitude], 16, { duration: 1.5 });
            }
          });
        }
        
        // Auto-start preference
        if (gpsAutoStart) {
          const autoStartPref = localStorage.getItem('gps_auto_start');
          if (autoStartPref !== null) {
            gpsAutoStart.checked = autoStartPref === 'true';
          }
          
          gpsAutoStart.addEventListener('change', function() {
            localStorage.setItem('gps_auto_start', this.checked.toString());
          });
        }
        
        // Listen for GPS position updates
        window.addEventListener('gps-position-update', function(event) {
          const position = event.detail.position;
          updateGPSStatus(true, position.coords);
        });
        
        // Check if GPS is already tracking
        if (window.gpsTracker && window.gpsTracker.isTracking) {
          updateGPSStatus(true, window.gpsTracker.lastPosition?.coords);
        }
      }
      
      // Load user profile
      async function loadUserProfile() {
        try {
          const response = await fetch(window.BASE_URL + '/me', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          
          if (response.ok) {
            const data = await response.json();
            userProfile = data.user;
            console.log('User profile loaded:', userProfile);
            updateProfileDisplay(data.user);
          }
        } catch (error) {
          console.error('Failed to load profile:', error);
        }
      }
      
      // Update profile display in nav
      function updateProfileDisplay(user) {
        const navProfile = document.getElementById('nav-profile');
        const navProfileInitial = document.getElementById('nav-profile-initial');
        const navProfileUsername = document.getElementById('nav-profile-username');
        
        if (!navProfile || !user) return;
        
        // Get user initial
        const initial = (user.username || user.email || 'U').charAt(0).toUpperCase();
        
        // Update elements
        if (navProfileInitial) {
          navProfileInitial.textContent = initial;
        }
        
        if (navProfileUsername) {
          navProfileUsername.textContent = user.username || user.email || 'User';
        }
        
        // Show the profile button
        navProfile.style.display = 'block';
      }
      
      // Initialize profile events
      function initProfileEvents() {
        const navProfileBtn = document.getElementById('nav-profile-btn');
        const navProfileMenu = document.getElementById('nav-profile-menu');
        const navLogout = document.getElementById('nav-logout');
        const navOpenProfile = document.getElementById('nav-open-profile');
        
        if (!navProfileBtn || !navProfileMenu) return;
        
        // Toggle profile menu
        navProfileBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          const isVisible = navProfileMenu.style.display === 'block';
          navProfileMenu.style.display = isVisible ? 'none' : 'block';
          navProfileBtn.setAttribute('aria-expanded', !isVisible);
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', function() {
          navProfileMenu.style.display = 'none';
          navProfileBtn.setAttribute('aria-expanded', 'false');
        });
        
        // Logout button
        if (navLogout) {
          navLogout.addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem(TOKEN_KEY);
            window.location.href = 'index.html';
          });
        }
        
        // Open profile button
        if (navOpenProfile) {
          navOpenProfile.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'profile.html';
          });
        }
      }

      let publicUserMarkers = [];

      async function updatePublicUsersMarkers() {
        if (!map) return;
        
        // Remove old markers
        publicUserMarkers.forEach(marker => map.removeLayer(marker));
        publicUserMarkers = [];
      
        try {
          const response = await window.api.get('/users/locations');
          if (response && response.users) {
            response.users.forEach(user => {
              if (!user.location) return;
              
              const flagEmoji = getFlagEmoji(user.country);
              const markerIcon = L.divIcon({
                className: 'public-user-marker',
                html: `
                  <div style="position: relative; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px;">
                    <div style="position: absolute; width: 40px; height: 40px; border-radius: 50%; background: rgba(106, 166, 255, 0.15);"></div>
                    <div style="position: relative; width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #a1c4fd, #c2e9fb); display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                      <div style="font-size: 14px;">${flagEmoji}</div>
                      <div style="font-size: 8px; font-weight: bold; color: #1b1b1b; max-width: 30px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${user.username.charAt(0)}</div>
                    </div>
                  </div>
                `,
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
              });
      
              const marker = L.marker([user.location.latitude, user.location.longitude], {
                icon: markerIcon
              }).addTo(map);
      
              marker.bindPopup(`
                <div style="text-align: center; min-width: 160px;">
                  <div style="font-weight: 800; margin-bottom: 5px;">${user.username}</div>
                  <div style="display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 5px;">
                    <span style="font-size: 20px;">${flagEmoji}</span>
                    <span>${user.country || 'Unknown'}</span>
                  </div>
                  <div class="small">üìç Live location</div>
                  <div class="small">Updated: ${new Date(user.location.timestamp).toLocaleTimeString()}</div>
                </div>
              `);
      
              publicUserMarkers.push(marker);
            });
          }
        } catch (err) {
          console.error('Failed to fetch public user locations:', err);
        }
      }
      
      // Call it periodically (every 30 seconds) when sharing is enabled? 
      // Or just call it once and rely on manual refresh?
      // We'll add a refresh interval when map is ready and the user is authenticated.
      let publicUsersInterval;
      function startPublicUsersPolling() {
        if (publicUsersInterval) clearInterval(publicUsersInterval);
        updatePublicUsersMarkers();
        publicUsersInterval = setInterval(updatePublicUsersMarkers, 30000); // every 30 sec
      }
      
      // Call startPublicUsersPolling() after map is initialized and user is logged in.
      
      
      
      // Initialize map
      function initMap() {
        map = L.map('map-container').setView([33.5138, 36.2765], 13);
        window.map = map;   // make globally accessible
      
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
          maxZoom: 19,
        }).addTo(map);
      
        L.control.scale({ imperial: false }).addTo(map);
      
        // Add robot marker right after map is ready
        addRobotMarker();
      
        console.log('Map initialized (static attractions removed)');
      }

      //
      function addRobotMarker() {
        if (!map) return;
      
        const robotIcon = L.divIcon({
          className: 'robot-marker',
          html: `
            <div style="
              position: relative;
              display: flex;
              align-items: center;
              justify-content: center;
              width: 56px;
              height: 56px;
            ">
              <!-- Outer glow -->
              <div style="
                position: absolute;
                width: 56px;
                height: 56px;
                border-radius: 50%;
                background: radial-gradient(circle, rgba(106,166,255,0.25) 0%, rgba(75,139,255,0) 70%);
                animation: pulse 2s infinite;
              "></div>
              <!-- Robot body -->
              <div style="
                position: relative;
                width: 44px;
                height: 44px;
                border-radius: 30% 70% 50% 50% / 40% 40% 60% 60%;
                background: linear-gradient(145deg, #6aa6ff, #4b8bff);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                border: 3px solid white;
                box-shadow: 0 6px 18px rgba(0,0,0,0.2);
                z-index: 20;
              ">
                <span style="font-size: 24px; line-height: 1;">ü§ñ</span>
                <span style="font-size: 10px; font-weight: bold; color: white; margin-top: -4px;">MUSEUM</span>
              </div>
              <!-- small tooltip arrow -->
              <div style="
                position: absolute;
                bottom: -10px;
                left: 50%;
                transform: translateX(-50%);
                width: 0;
                height: 0;
                border-left: 8px solid transparent;
                border-right: 8px solid transparent;
                border-top: 10px solid #4b8bff;
                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
              "></div>
            </div>
          `,
          iconSize: [56, 66],
          iconAnchor: [28, 66],
          popupAnchor: [0, -66]
        });
      
        const marker = L.marker([33.5155, 36.2931], {
          icon: robotIcon,
          zIndexOffset: 800
        }).addTo(map);
      
        marker.bindPopup(`
          <div style="text-align: center; min-width: 200px; padding: 8px;">
            <div style="font-size: 28px; margin-bottom: 4px;">ü§ñ</div>
            <h3 style="margin: 4px 0; color: #0f1720;">National Museum of Damascus</h3>
            <p style="font-size: 13px; color: #3a4a5a; margin: 8px 0;">
              Syria‚Äôs premier museum ‚Äì home to ancient treasures,<br>Roman artefacts, and the famous Dura‚ÄëEuropos synagogue.
            </p>
            <div style="display: flex; justify-content: center; gap: 8px; margin-top: 8px;">
              <span style="background: var(--cream-2); padding: 4px 10px; border-radius: 20px; font-size: 11px;">üèõÔ∏è museum</span>
              <span style="background: var(--cream-2); padding: 4px 10px; border-radius: 20px; font-size: 11px;">‚≠ê 4.6</span>
            </div>
          </div>
        `);
      }
      
      // Main initialization
      async function init() {
        // Load user profile first
        await loadUserProfile();
        
        // Initialize map
        initMap();
        
        // Initialize profile events
        initProfileEvents();
        
        // Initialize GPS controls
        initGPSControls();

        startPublicUsersPolling();


        window.addEventListener('beforeunload', () => {
          if (publicUsersInterval) {
            clearInterval(publicUsersInterval);
            publicUsersInterval = null;
          }
        });
        
        // Initialize GPS tracker
        if (window.gpsTracker) {
          window.gpsTracker.initialize().then(initialized => {
            console.log('GPS Tracker initialized:', initialized);
            
            // Auto-start if user has consented
            const locationConsent = localStorage.getItem('location_consent') !== 'false';
            if (token && locationConsent && initialized) {
              setTimeout(() => {
                window.gpsTracker.startTracking().then(success => {
                  console.log('Auto-started GPS tracking:', success);
                });
              }, 1000);
            }
          });
        }
      }
      
      // Start everything when DOM is loaded
      document.addEventListener('DOMContentLoaded', init);
    })();



    
    // Recommendation system
    (function() {
      let recommendationMarkers = [];
      let currentRecommendations = [];
      
      // Recommendation marker colors based on score
      const getRecommendationColor = (score) => {
        if (score >= 0.8) return '#4CAF50'; // Green
        if (score >= 0.6) return '#FFC107'; // Yellow
        if (score >= 0.4) return '#FF9800'; // Orange
        return '#F44336'; // Red
      };
      
      // Clear recommendation markers
      function clearRecommendationMarkers() {
        recommendationMarkers.forEach(marker => {
          if (window.map && marker) map.removeLayer(marker);
        });
        recommendationMarkers = [];
      }
      
      // Add recommendation marker to map
      function addRecommendationMarker(place) {
        if (!window.map) return;
        
        const score = place.score || 0.5;
        const color = getRecommendationColor(score);
        
        const recommendationIcon = L.divIcon({
          className: 'recommendation-marker',
          html: `
            <div style="
              position: relative;
              display: flex;
              align-items: center;
              justify-content: center;
              width: 48px;
              height: 48px;
            ">
              <!-- Outer glow -->
              <div style="
                position: absolute;
                width: 48px;
                height: 48px;
                border-radius: 50%;
                background: ${color}20;
                animation: pulse 2s infinite;
              "></div>
              
              <!-- Star background -->
              <div style="
                position: relative;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                background: ${color};
                display: flex;
                align-items: center;
                justify-content: center;
                border: 3px solid white;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10;
              ">
                <!-- Star emoji -->
                <div style="font-size: 16px; color: white;">üåü</div>
                
                <!-- Score badge -->
                <div style="
                  position: absolute;
                  bottom: -8px;
                  right: -8px;
                  width: 24px;
                  height: 24px;
                  border-radius: 50%;
                  background: white;
                  border: 2px solid ${color};
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 10px;
                  font-weight: bold;
                  color: ${color};
                  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                ">
                  ${Math.round(score * 100)}
                </div>
              </div>
            </div>
          `,
          iconSize: [48, 48],
          iconAnchor: [24, 48],
          popupAnchor: [0, -48]
        });
        
        const marker = L.marker([place.latitude, place.longitude], {
          icon: recommendationIcon,
          zIndexOffset: 900
        }).addTo(window.map);
        
        // Enhanced popup for recommendations
        const popupContent = `
          <div style="min-width: 280px; max-width: 320px; padding: 16px;">
            <!-- Header with score -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <h3 style="margin: 0; font-size: 18px; color: #1b1b1b;">${place.name}</h3>
              <div style="
                padding: 4px 8px;
                background: ${color}20;
                color: ${color};
                border-radius: 12px;
                font-size: 12px;
                font-weight: bold;
              ">
                ${Math.round(score * 100)}% match
              </div>
            </div>
            
            <!-- Basic info -->
            <div style="margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 14px; color: #7b7b7b;">üìç ${place.distance_km ? place.distance_km.toFixed(1) + ' km away' : 'Nearby'}</span>
                <span style="font-size: 14px; color: #7b7b7b;">üí∞ ${place.price_category || 'Medium'}</span>
                <span style="font-size: 14px; color: #7b7b7b;">‚≠ê ${place.rating || 'N/A'}/5</span>
              </div>
              <p style="margin: 0; font-size: 14px; line-height: 1.5; color: #444;">
                ${place.description || 'No description available.'}
              </p>
            </div>
            
            <!-- Score breakdown -->
            ${place.scores ? `
            <div style="background: var(--cream-2); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
              <div style="font-size: 12px; font-weight: 600; color: var(--muted); margin-bottom: 8px;">Score Breakdown</div>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; font-size: 11px;">
                ${place.scores.preference !== undefined ? `
                <div style="display: flex; justify-content: space-between;">
                  <span>Preference:</span>
                  <span style="font-weight: 600;">${(place.scores.preference * 100).toFixed(0)}%</span>
                </div>
                ` : ''}
                ${place.scores.distance !== undefined ? `
                <div style="display: flex; justify-content: space-between;">
                  <span>Distance:</span>
                  <span style="font-weight: 600;">${(place.scores.distance * 100).toFixed(0)}%</span>
                </div>
                ` : ''}
                ${place.scores.budget !== undefined ? `
                <div style="display: flex; justify-content: space-between;">
                  <span>Budget:</span>
                  <span style="font-weight: 600;">${(place.scores.budget * 100).toFixed(0)}%</span>
                </div>
                ` : ''}
                ${place.scores.popularity !== undefined ? `
                <div style="display: flex; justify-content: space-between;">
                  <span>Popularity:</span>
                  <span style="font-weight: 600;">${(place.scores.popularity * 100).toFixed(0)}%</span>
                </div>
                ` : ''}
              </div>
            </div>
            ` : ''}
            
            <!-- Tags -->
            ${place.tags && place.tags.length > 0 ? `
            <div style="margin-bottom: 12px;">
              <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                ${place.tags.map(tag => `
                  <span style="
                    padding: 4px 8px;
                    background: rgba(106, 166, 255, 0.1);
                    color: var(--accent);
                    border-radius: 12px;
                    font-size: 11px;
                    font-weight: 600;
                  ">${tag}</span>
                `).join('')}
              </div>
            </div>
            ` : ''}
            
            <!-- Actions -->
            <div style="display: flex; gap: 8px; margin-top: 12px;">
              <button onclick="trackPlaceActivity('${place.id}', 'viewed')" style="
                flex: 1;
                padding: 8px 12px;
                background: var(--cream-2);
                border: 1px solid rgba(0,0,0,0.08);
                border-radius: 8px;
                font-size: 12px;
                font-weight: 600;
                color: #444;
                cursor: pointer;
              ">
                üëÅÔ∏è View Details
              </button>
              <button onclick="markAsVisited('${place.id}')" style="
                flex: 1;
                padding: 8px 12px;
                background: var(--accent);
                border: none;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 600;
                color: white;
                cursor: pointer;
              ">
                ‚úÖ Mark Visited
              </button>
            </div>
          </div>
        `;
        
        marker.bindPopup(popupContent);
        
        // Track when user clicks on recommendation
        marker.on('popupopen', () => {
          trackPlaceActivity(place.id, 'clicked');
        });
        
        recommendationMarkers.push(marker);
        return marker;
      }


      
      
      // Load recommendations from backend
      async function loadRecommendations() {
        const loadingEl = document.getElementById('recommendations-loading');
        const listEl = document.getElementById('recommendations-list');
        const noRecEl = document.getElementById('no-recommendations');
        
        if (loadingEl) loadingEl.style.display = 'block';
        if (listEl) listEl.innerHTML = '';
        if (noRecEl) noRecEl.style.display = 'none';
        
        try {
          const token = localStorage.getItem('st_token');
          const response = await fetch(`${window.BASE_URL}/me/recommendations`, {
            headers: {
              'Authorization': 'Bearer ' + token
            }
          });
          
          if (!response.ok) {
            throw new Error('Failed to fetch recommendations');
          }
          
          const data = await response.json();
          currentRecommendations = data.recommendations || [];
          
          if (loadingEl) loadingEl.style.display = 'none';
          
          if (currentRecommendations.length === 0) {
            if (noRecEl) noRecEl.style.display = 'block';
            return;
          }
          
          // Display recommendations in list
          if (listEl) {
            listEl.innerHTML = currentRecommendations.map((place, index) => {
              const score = place.score || 0.5;
              const color = getRecommendationColor(score);
              
              return `
                <div class="recommendation-card" style="
                  background: white;
                  border-radius: 12px;
                  padding: 16px;
                  border: 1px solid rgba(0,0,0,0.06);
                  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
                  transition: transform 0.2s ease;
                  cursor: pointer;
                " onclick="focusOnRecommendation(${index})" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div>
                      <div style="font-weight: 800; font-size: 16px; color: #1b1b1b; margin-bottom: 4px;">${place.name}</div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 12px; color: #7b7b7b;">${place.category || 'Attraction'}</span>
                        <span style="font-size: 12px; color: #7b7b7b;">‚Ä¢</span>
                        <span style="font-size: 12px; color: #7b7b7b;">${place.distance_km ? place.distance_km.toFixed(1) + ' km' : 'Nearby'}</span>
                      </div>
                    </div>
                    <div style="
                      padding: 4px 8px;
                      background: ${color}20;
                      color: ${color};
                      border-radius: 12px;
                      font-size: 12px;
                      font-weight: bold;
                    ">
                      ${Math.round(score * 100)}%
                    </div>
                  </div>
                  
                  <p style="
                    font-size: 13px;
                    color: #666;
                    line-height: 1.5;
                    margin-bottom: 12px;
                    display: -webkit-box;
                    -webkit-line-clamp: 2;
                    -webkit-box-orient: vertical;
                    overflow: hidden;
                  ">${place.description || ''}</p>
                  
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span style="font-size: 12px; color: #7b7b7b;">üí∞ ${place.price_category || 'Medium'}</span>
                      <span style="font-size: 12px; color: #7b7b7b;">‚≠ê ${place.rating || 'N/A'}/5</span>
                    </div>
                    <button onclick="event.stopPropagation(); showOnMap('${place.id}')" style="
                      padding: 6px 12px;
                      background: var(--accent);
                      border: none;
                      border-radius: 8px;
                      font-size: 12px;
                      font-weight: 600;
                      color: white;
                      cursor: pointer;
                    ">
                      Show on Map
                    </button>
                  </div>
                </div>
              `;
            }).join('');
          }
          
        } catch (error) {
          console.error('Error loading recommendations:', error);
          if (loadingEl) loadingEl.style.display = 'none';
          if (noRecEl) {
            noRecEl.innerHTML = '<p class="small">Failed to load recommendations. Please try again later.</p>';
            noRecEl.style.display = 'block';
          }
        }
      }
      
      // Show all recommendations on map
      function showAllRecommendationsOnMap() {
        clearRecommendationMarkers();
        
        if (!currentRecommendations.length) {
          alert('No recommendations available. Please refresh first.');
          return;
        }
        
        currentRecommendations.forEach(place => {
          addRecommendationMarker(place);
        });
        
        // Fit map to show all recommendation markers
        if (recommendationMarkers.length > 0) {
          const group = L.featureGroup(recommendationMarkers);
          window.map.fitBounds(group.getBounds().pad(0.1));
        }
      }
      
      // Focus on a specific recommendation
      window.focusOnRecommendation = function(index) {
        if (!currentRecommendations[index]) return;
        
        const place = currentRecommendations[index];
        
        // Clear existing markers and show only this one
        clearRecommendationMarkers();
        const marker = addRecommendationMarker(place);
        
        // Center map on this place
        window.map.setView([place.latitude, place.longitude], 16);
        
        // Open popup
        setTimeout(() => {
          if (marker) marker.openPopup();
        }, 500);
      };
      
      // Show single place on map
      window.showOnMap = function(placeId) {
        const place = currentRecommendations.find(p => p.id === placeId);
        if (!place) return;
        
        clearRecommendationMarkers();
        const marker = addRecommendationMarker(place);
        
        window.map.setView([place.latitude, place.longitude], 16);
        setTimeout(() => {
          if (marker) marker.openPopup();
        }, 500);
      };
      
      // Track user activity for a place
      window.trackPlaceActivity = async function(placeId, activityType) {
        try {
          const token = localStorage.getItem('st_token');
          await fetch(`${window.BASE_URL}/me/activity`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              place_id: placeId,
              activity_type: activityType,
              metadata: { timestamp: new Date().toISOString() }
            })
          });
        } catch (error) {
          console.error('Error tracking activity:', error);
        }
      };
      
      // Mark place as visited
      window.markAsVisited = async function(placeId) {
        if (!confirm('Mark this place as visited?')) return;
        
        try {
          const token = localStorage.getItem('st_token');
          await fetch(`${window.BASE_URL}/me/visited`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              place_id: placeId,
              timestamp: new Date().toISOString()
            })
          });
          
          alert('Place marked as visited! Your future recommendations will be updated.');
          
          // Refresh recommendations
          loadRecommendations();
          
        } catch (error) {
          console.error('Error marking as visited:', error);
          alert('Failed to mark as visited. Please try again.');
        }
      };
      
      // Initialize recommendation system when page loads
      document.addEventListener('DOMContentLoaded', function() {
        const refreshBtn = document.getElementById('refresh-recommendations');
        const showAllBtn = document.getElementById('show-all-recommendations');
        
        if (refreshBtn) {
          refreshBtn.addEventListener('click', loadRecommendations);
        }
        
        if (showAllBtn) {
          showAllBtn.addEventListener('click', showAllRecommendationsOnMap);
        }
        
        // Auto-load recommendations after a short delay
        setTimeout(loadRecommendations, 2000);
      });
      
      // Export functions to global scope
      window.recommendationSystem = {
        loadRecommendations,
        showAllRecommendationsOnMap,
        clearRecommendationMarkers
      };
    })();
  </script>
</body>
</html>





